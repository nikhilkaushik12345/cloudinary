<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cloudinary Folder Cleanup</title>
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; max-width: 900px; margin: 0 auto; background: #f4f6f8; color: #333; }
  h1 { color: #1a1a1a; border-bottom: 2px solid #e1e4e8; padding-bottom: 10px; }
  
  .card { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; }
  
  button { 
    padding: 12px 24px; font-size: 16px; font-weight: 600; cursor: pointer; 
    border: none; border-radius: 6px; transition: background 0.2s; 
  }
  .btn-primary { background: #0070f3; color: white; }
  .btn-primary:hover { background: #0051a2; }
  .btn-danger { background: #d93025; color: white; }
  .btn-danger:hover { background: #b02015; }
  button:disabled { background: #ccc; cursor: not-allowed; }

  pre { background: #2d2d2d; color: #eee; padding: 15px; border-radius: 6px; overflow-x: auto; font-size: 13px; }
  
  table { width: 100%; border-collapse: collapse; margin-top: 15px; }
  th, td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; }
  th { background-color: #f8f9fa; font-weight: 600; }
  .status-success { color: green; font-weight: bold; }
  .status-failed { color: red; font-weight: bold; }
  
  .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 2s linear infinite; display: inline-block; vertical-align: middle; margin-right: 10px; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
<script>
let currentToken = null;

// 1. Initial Login Redirect
function login() {
  const authUrl =
    "https://asset-management.mcp.cloudinary.com/authorize" +
    "?client_id=mcp_client_Qr1NLTYTBYCOYW4h" +
    "&redirect_uri=" + encodeURIComponent("https://cloudinary-2w50.onrender.com/callback") +
    "&response_type=code" +
    "&code_challenge=KvifpPaokX4NX3fTbLxnhhpXPZdxx-7k2asvNG_SdbI" +
    "&code_challenge_method=S256";
  window.location.href = authUrl;
}

// 2. Exchange Code for Token
async function handleCallback(code) {
  const log = document.getElementById("auth-log");
  log.textContent = "Processing login...";
  
  try {
    const res = await fetch("/exchange", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ code })
    });
    const data = await res.json();
    
    if (data.access_token) {
      currentToken = data.access_token;
      document.getElementById("login-section").style.display = "none";
      document.getElementById("cleanup-section").style.display = "block";
      log.textContent = ""; 
    } else {
      log.textContent = "Login Failed: " + JSON.stringify(data);
    }
  } catch (err) {
    log.textContent = "Network Error: " + err.message;
  }
}

// 3. Run Cleanup Logic
async function runCleanup() {
  if (!currentToken) return alert("Not authenticated");
  
  const btn = document.getElementById("cleanup-btn");
  const outputDiv = document.getElementById("output");
  const statusDiv = document.getElementById("status-msg");
  
  btn.disabled = true;
  statusDiv.innerHTML = '<div class="loader"></div> Running Cleanup... This may take a minute.';
  outputDiv.innerHTML = ""; // Clear previous results

  try {
    const res = await fetch("/cleanup-folders", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ access_token: currentToken })
    });
    
    const data = await res.json();
    
    // Render Results
    statusDiv.textContent = "Cleanup Complete!";
    renderReport(data);

  } catch (err) {
    statusDiv.textContent = "Error: " + err.message;
  } finally {
    btn.disabled = false;
  }
}

function renderReport(data) {
  const container = document.getElementById("output");
  
  // Section 1: Folders Found
  const foldersHTML = (data.folders_found && data.folders_found.length > 0)
    ? `<ul>${data.folders_found.map(f => `<li><strong>${f.path}</strong> (created: ${f.created_at})</li>`).join('')}</ul>`
    : `<p>No folders found.</p>`;

  // Section 2: Deletion Table
  let tableHTML = "";
  if (data.deletion_report && data.deletion_report.length > 0) {
    tableHTML = `
      <table>
        <thead><tr><th>Folder Name</th><th>Status</th><th>Details</th></tr></thead>
        <tbody>
          ${data.deletion_report.map(row => `
            <tr>
              <td>${row.folder}</td>
              <td class="${row.status === 'Success' ? 'status-success' : 'status-failed'}">${row.status}</td>
              <td>${row.details || row.error || '-'}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
  }

  container.innerHTML = `
    <h3>1. Search Results</h3>
    ${foldersHTML}
    <h3>2. Deletion Report</h3>
    ${tableHTML}
    <h4>Raw Response</h4>
    <pre>${JSON.stringify(data, null, 2)}</pre>
  `;
}

window.onload = () => {
  const code = new URLSearchParams(window.location.search).get('code');
  if (code) handleCallback(code);
};
</script>
</head>
<body>

  <h1>Cloudinary Folder Cleanup Tool</h1>

  <!-- Login Section -->
  <div id="login-section" class="card">
    <p>Please login to Cloudinary to start the session.</p>
    <button class="btn-primary" onclick="login()">Login with Cloudinary</button>
    <p id="auth-log" style="color:red; margin-top:10px;"></p>
  </div>

  <!-- Cleanup Section (Hidden until login) -->
  <div id="cleanup-section" class="card" style="display:none;">
    <h2>Action Required</h2>
    <p>Click below to find all folders and delete them sequentially.</p>
    
    <button id="cleanup-btn" class="btn-danger" onclick="runCleanup()">
      üóëÔ∏è Search & Delete All Folders
    </button>
    
    <div id="status-msg" style="margin-top:15px; font-weight:bold;"></div>
    
    <div id="output" style="margin-top: 20px;"></div>
  </div>

</body>
</html>
