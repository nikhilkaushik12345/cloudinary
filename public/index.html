<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cloudinary MCP Explorer</title>
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; max-width: 900px; margin: 0 auto; background: #f9f9f9; }
  h1 { color: #111; }
  .section { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
  button { padding: 10px 20px; font-size: 16px; cursor: pointer; background: #0070f3; color: white; border: none; border-radius: 5px; }
  button:hover { background: #0051a2; }
  button:disabled { background: #ccc; cursor: not-allowed; }
  pre { background: #2d2d2d; color: #eee; padding: 15px; border-radius: 6px; overflow-x: auto; max-height: 500px; font-size: 14px; }
</style>
<script>
let accessToken = null;

function login() {
  const authUrl =
    "https://asset-management.mcp.cloudinary.com/authorize" +
    "?client_id=mcp_client_Qr1NLTYTBYCOYW4h" +
    "&redirect_uri=" + encodeURIComponent("https://cloudinary-2w50.onrender.com/callback") +
    "&response_type=code" +
    "&code_challenge=KvifpPaokX4NX3fTbLxnhhpXPZdxx-7k2asvNG_SdbI" +
    "&code_challenge_method=S256";
  window.location.href = authUrl;
}

async function exchangeCode(code) {
  const log = document.getElementById("auth-log");
  log.textContent = "Exchanging code...";
  
  try {
    const res = await fetch("/exchange", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ code })
    });
    const data = await res.json();
    
    if (data.access_token) {
      accessToken = data.access_token;
      log.textContent = "Token Received!\n" + JSON.stringify(data, null, 2);
      document.getElementById("tools-section").style.display = "block";
      document.getElementById("cleanup-section").style.display = "block"; // Show cleanup section
      document.getElementById("login-btn").style.display = "none";
    } else {
      log.textContent = "Error: " + JSON.stringify(data, null, 2);
    }
  } catch (err) {
    log.textContent = "Network Error: " + err.message;
  }
}

async function listTools() {
  const log = document.getElementById("tools-log");
  const btn = document.getElementById("list-btn");
  
  btn.disabled = true;
  btn.textContent = "Connecting to MCP...";
  log.textContent = "Starting MCP handshake...";

  try {
    const res = await fetch("/list-tools", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ access_token: accessToken })
    });
    const data = await res.json();
    log.textContent = JSON.stringify(data, null, 2);
  } catch (err) {
    log.textContent = "Error: " + err.message;
  } finally {
    btn.disabled = false;
    btn.textContent = "List Tools Again";
  }
}

// NEW: Cleanup Function
async function runCleanup() {
  const log = document.getElementById("cleanup-log");
  const btn = document.getElementById("cleanup-btn");
  
  btn.disabled = true;
  btn.textContent = "Running Cleanup...";
  log.textContent = "Searching for folders and deleting...";

  try {
    const res = await fetch("/cleanup-folders", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ access_token: accessToken })
    });
    const data = await res.json();
    log.textContent = JSON.stringify(data, null, 2);
  } catch (err) {
    log.textContent = "Error: " + err.message;
  } finally {
    btn.disabled = false;
    btn.textContent = "Run Cleanup Again";
  }
}

window.onload = () => {
  const code = new URLSearchParams(window.location.search).get('code');
  if (code) exchangeCode(code);
};
</script>
</head>
<body>
  <h1>Cloudinary MCP Explorer</h1>

  <div class="section">
    <h2>1. Authentication</h2>
    <button id="login-btn" onclick="login()">Login with Cloudinary</button>
    <pre id="auth-log">Waiting for login...</pre>
  </div>

  <div id="tools-section" class="section" style="display:none;">
    <h2>2. MCP Tools</h2>
    <p>Click below to connect to the MCP server and list available tools.</p>
    <button id="list-btn" onclick="listTools()">List MCP Tools</button>
    <pre id="tools-log">Tools will appear here...</pre>
  </div>

  <!-- NEW SECTION ADDED BELOW -->
  <div id="cleanup-section" class="section" style="display:none;">
    <h2>3. Cleanup Folders</h2>
    <p>Search for all folders and delete them sequentially.</p>
    <button id="cleanup-btn" onclick="runCleanup()" style="background: #d93025;">Delete All Folders</button>
    <pre id="cleanup-log">Waiting...</pre>
  </div>

</body>
</html>
